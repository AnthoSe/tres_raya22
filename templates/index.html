<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Tres en Raya IA</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(to right, #ffecd2, #fcb69f);
        text-align: center;
        margin: 0;
        padding: 20px;
      }
      h1 {
        color: #2c3e50;
        margin-bottom: 20px;
      }
      table {
        margin: 20px auto;
        border-collapse: collapse;
      }
      td {
        width: 100px;
        height: 100px;
        font-size: 42px;
        font-weight: bold;
        border: 4px solid #fff;
        background-color: #ffffffcc;
        transition: background-color 0.3s ease, transform 0.2s;
        cursor: default;
        box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        user-select: none;
      }
      td.x {
        color: #e74c3c;
      }
      td.o {
        color: #2980b9;
      }
      td:hover {
        background-color: #f7f7f7;
        transform: scale(1.05);
      }
      button {
        padding: 12px 20px;
        margin: 10px;
        font-size: 1.4rem;
        border: none;
        border-radius: 8px;
        background-color: #27ae60;
        color: white;
        font-weight: bold;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #1e8449;
      }
      #razon {
        margin-top: 20px;
        color: #2c3e50;
        font-weight: bold;
        font-size: 1.4rem;
        min-height: 40px;
      }
      #historial {
        max-width: 800px;
        margin: 30px auto;
        background: #ffffffcc;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        text-align: left;
        font-size: 1.3rem;
        min-height: 100px;
        overflow-y: auto;
        line-height: 1.5;
        user-select: text;
      }
      #error-msg {
        display: none;
        background-color: #f44336;
        color: white;
        padding: 10px;
        margin: 10px auto;
        border-radius: 5px;
        max-width: 50%;
        font-size: 1.2rem;
      }
      /* BotÃ³n Evaluar Ãšltima Jugada */
      #btn-evaluar {
        display: inline-block;
        padding: 12px 20px;
        background-color: #2980b9;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: bold;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        transition: background-color 0.3s ease;
        margin-top: 20px;
        font-size: 1.2rem;
      }
      #btn-evaluar:hover {
        background-color: #1c5980;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ¤– Tres en Raya con IA</h1>

    <table id="tablero" aria-label="Tablero de Tres en Raya"></table>
    <div id="razon" role="status" aria-live="polite"></div>

    <button onclick="jugarTurno()">Jugar paso a paso</button>
    <button onclick="jugarAuto()">Jugar automÃ¡tico</button>
    <button onclick="siguientePartida()">Siguiente partida</button>
    <button onclick="reiniciar()">Reiniciar</button>

    <div id="error-msg" role="alert"></div>

    <h3 style="font-size: 1.2rem">ðŸ“œ Historial de jugadas</h3>
    <div id="historial" aria-live="polite"></div>

    <!-- BotÃ³n para evaluar Ãºltima jugada -->
    <a href="/evaluar" id="btn-evaluar" role="button" aria-label="Evaluar Ãºltima jugada">Evaluar Ãšltima Jugada</a>

    <script>
      let jugando = true;
      let historial = [];
      let modoAuto = false;

      function renderTablero(tablero) {
        const table = document.getElementById("tablero");
        table.innerHTML = "";
        for (let i = 0; i < 3; i++) {
          const row = document.createElement("tr");
          for (let j = 0; j < 3; j++) {
            const cell = document.createElement("td");
            const value = tablero[i][j];
            if (value !== "b") {
              cell.innerText = value.toUpperCase();
              cell.classList.add(value);
            }
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
      }

      function renderHistorial() {
        const div = document.getElementById("historial");
        if(historial.length === 0){
          div.innerHTML = "<em>No hay jugadas aÃºn.</em>";
          return;
        }
        div.innerHTML = historial
          .map(
            (h, idx) =>
              `#${idx + 1}: <b>${h.jugador.toUpperCase()}</b> (${h.modelo}) â€“ ${h.razon}`
          )
          .join("<br>");
      }

      function jugarTurno() {
        if (!jugando) return;

        fetch("/jugar_turno", { method: "POST" })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              mostrarError("Jugada invÃ¡lida: " + data.error);
              jugando = false;
              return;
            }

            renderTablero(data.tablero);
            document.getElementById(
              "razon"
            ).innerHTML = `Jugador <b>${data.jugador.toUpperCase()}</b> (${
              data.modelo
            }): ${data.razon}`;

            historial.push({
              jugador: data.jugador,
              razon: data.razon,
              modelo: data.modelo,
            });

            renderHistorial();

            if (data.ganador === "empate") {
              document.getElementById("razon").innerHTML +=
                "<br><b>Â¡Empate!</b>";
              jugando = false;
            } else if (data.ganador) {
              document.getElementById(
                "razon"
              ).innerHTML += `<br><b>Ganador: ${data.ganador.toUpperCase()}</b>`;
              jugando = false;
            }

            if (modoAuto && jugando) {
              setTimeout(jugarTurno, 150);
            }
          })
          .catch((err) => {
            mostrarError("Error en la comunicaciÃ³n con el servidor.");
            console.error(err);
            jugando = false;
          });
      }

      function jugarAuto() {
        if (!jugando) return;
        modoAuto = true;
        jugarTurno();
      }

      function siguientePartida() {
        fetch("/siguiente_partida", {
          method: "POST",
        })
          .then((res) => res.json())
          .then((data) => {
            jugando = true;
            modoAuto = false;
            historial = [];
            ocultarError();
            document.getElementById("razon").innerText = "";
            document.getElementById("historial").innerText = "";

            fetch("/estado")
              .then((res) => res.json())
              .then((data) => renderTablero(data.tablero));
          })
          .catch((err) => {
            mostrarError("No se pudo reiniciar la partida.");
            console.error(err);
          });
      }

      function mostrarError(mensaje) {
        const errorDiv = document.getElementById("error-msg");
        errorDiv.textContent = mensaje;
        errorDiv.style.display = "block";
      }

      function ocultarError() {
        const errorDiv = document.getElementById("error-msg");
        errorDiv.style.display = "none";
      }

      function reiniciar() {
        fetch("/reiniciar", { method: "POST" })
          .then(() => {
            jugando = true;
            modoAuto = false;
            historial = [];
            document.getElementById("razon").innerText = "";
            document.getElementById("historial").innerText = "";
            ocultarError();

            fetch("/estado")
              .then((res) => res.json())
              .then((data) => renderTablero(data.tablero));
          })
          .catch((err) => {
            mostrarError("No se pudo reiniciar el juego.");
            console.error(err);
          });
      }

      // Iniciar con tablero limpio
      reiniciar();
    </script>
  </body>
</html>
