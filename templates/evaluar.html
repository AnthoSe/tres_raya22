<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Evaluar √öltima Jugada - Tres en Raya IA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: linear-gradient(135deg, #f8fafc, #e0e7ff);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
      }

      .container {
        max-width: 650px;
        margin: 3rem auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 15px 25px rgba(0, 0, 0, 0.1);
        padding: 2rem 2.5rem;
        position: relative;
        z-index: 1;
      }

      h1 {
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 2rem;
        text-align: center;
        letter-spacing: 1.1px;
      }

      /* Tablero como tabla */
      table.tablero {
        border-collapse: collapse;
        width: 200px;
        margin: 0 auto 2rem auto;
        text-align: center;
        font-weight: bold;
        font-size: 24px;
        user-select: none;
      }

      table.tablero td {
        width: 60px;
        height: 60px;
        border: 2px solid #cbd5e1;
        vertical-align: middle;
        font-weight: bold;
        font-size: 24px;
        color: #334155;
      }

      table.tablero td.x {
        color: #e74c3c;
      }

      table.tablero td.o {
        color: #2980b9;
      }

      /* Resaltar la celda de la √∫ltima jugada */
      table.tablero td.marcada {
        background-color: #fff8dc;
        border: 3px solid #f1c40f;
      }

      .btn-back {
        position: fixed;
        top: 20px;
        left: 20px;
        background: #64748b;
        color: white;
        font-weight: 600;
        border-radius: 10px;
        padding: 0.6rem 1.1rem;
        box-shadow: 0 6px 10px rgb(0 0 0 / 0.15);
        border: none;
        cursor: pointer;
        z-index: 1000;
      }

      .btn-history {
        display: block;
        width: 100%;
        margin-top: 1.5rem;
        font-weight: 600;
        border-radius: 12px;
        padding: 0.8rem 1.2rem;
        background-color: #2563eb;
        color: white;
        text-align: center;
        text-decoration: none;
      }

      .rubrica-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }

      /* Sidebar de r√∫brica */
      .rubrica-panel {
        position: fixed;
        top: 0;
        right: -500px;
        width: 480px;
        height: 100%;
        background: #ffffff;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        overflow-y: auto;
        transition: right 0.4s ease;
        z-index: 1050;
      }

      .rubrica-panel.open {
        right: 0;
      }

      .rubrica-panel h2 {
        font-size: 1.5rem;
        margin-bottom: 1.2rem;
        font-weight: 700;
        text-align: center;
      }

      .rubrica-panel table {
        font-size: 0.85rem;
      }

      .rubrica-panel .btn-close {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <!-- Botones fijos -->
    <button
      class="btn btn-secondary btn-back"
      onclick="window.location.href='/'"
    >
      ‚Üê Inicio
    </button>
    <button class="btn btn-outline-info rubrica-btn" onclick="toggleRubrica()">
      üìò Ver R√∫brica
    </button>

    <!-- Panel lateral de r√∫brica -->
    <div class="rubrica-panel" id="rubricaPanel">
      <button class="btn btn-sm btn-light btn-close" onclick="toggleRubrica()">
        ‚úï
      </button>
      <h2>R√∫brica de Evaluaci√≥n</h2>
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Dimensi√≥n</th>
            <th>Nivel 1</th>
            <th>Nivel 2</th>
            <th>Nivel 3</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Comprensi√≥n de Reglas</td>
            <td>Viola reglas b√°sicas</td>
            <td>Cumple reglas b√°sicas</td>
            <td>Siempre legal</td>
          </tr>
          <tr>
            <td>Validez y Legalidad</td>
            <td>Movimiento inv√°lido</td>
            <td>V√°lido, sin an√°lisis</td>
            <td>V√°lido y analizado</td>
          </tr>
          <tr>
            <td>Razonamiento Estrat√©gico</td>
            <td>Sin l√≥gica</td>
            <td>Intenci√≥n simple</td>
            <td>Justificaci√≥n anticipada</td>
          </tr>
          <tr>
            <td>Factualidad</td>
            <td>Explicaci√≥n incorrecta</td>
            <td>Correcta, imprecisa</td>
            <td>Basada en hechos concretos</td>
          </tr>
          <tr>
            <td>Coherencia Explicativa</td>
            <td>Confusa</td>
            <td>Clara pero superficial</td>
            <td>L√≥gica y completa</td>
          </tr>
          <tr>
            <td>Claridad Ling√º√≠stica</td>
            <td>Errores graves</td>
            <td>Peque√±os errores</td>
            <td>Gram√°tica precisa</td>
          </tr>
          <tr>
            <td>Adaptabilidad</td>
            <td>Ignora jugada previa</td>
            <td>Adaptaci√≥n b√°sica</td>
            <td>Se adapta eficazmente</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="container">
      <h1>Evaluar √öltima Jugada</h1>

      {% if jugada %}
      <p class="text-center fw-semibold mb-3" style="font-size: 1.2rem">
        √öltima jugada.
      </p>

      <!-- TABLERO -->
      <!-- <table class="tablero" role="grid">
        {% for fila in jugada.tablero %}
          {% set fila_idx = loop.index0 %}
          <tr>
            {% for celda in fila %}
              {% set col_idx = loop.index0 %}
              {% set marcado = (jugada.movimiento[1]|int - 1 == fila_idx and jugada.movimiento[2]|int - 1 == col_idx) %}
              <td class="
                {% if celda == 'x' %}x{% elif celda == 'o' %}o{% endif %}
                {{ ' marcada' if marcado else '' }}">
                {{ celda|upper if celda != 'b' else '' }}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </table> -->

      <!-- TABLERO -->
      <div id="tablero-dinamico" class="mt-3 mb-3"></div>

      <!-- INFO DE LA JUGADA -->
      <!-- <div class="text-center mb-4 mt-4" style="font-size: 1.2rem">
        <p><strong>Jugador:</strong> {{ jugada.jugador | upper }}</p>
        <p><strong>Modelo:</strong> {{ jugada.modelo }}</p>
        <p>
          <strong>Movimiento:</strong>
          {% if jugada.movimiento[0] == 'mark' %} Marcar fila {{
          jugada.movimiento[1] }}, columna {{ jugada.movimiento[2] }} {% else %}
          {{ jugada.movimiento }} {% endif %}
        </p>
      </div> -->

      <div
        id="info-jugada"
        aria-live="polite"
        style="margin-top: 1rem; font-size: 1.2rem"
        class="mb-4 mt-4 text-center"
      >
        INFO DE LA JUGADA: Cargando...
      </div>

      <!-- INFO DE LA JUGADA -->
      <!-- <div
        id="info-jugada"
        class="text-center mb-4 mt-4"
        style="font-size: 1.2rem"
      >
        <p><em>Cargando informaci√≥n de la jugada...</em></p>
      </div> -->

      <!-- FORMULARIOS GUARDAR / SIGUIENTE LADO A LADO -->
      <div class="d-flex gap-3 flex-wrap">
        <!-- Guardar evaluaci√≥n -->
        <form
          action="/guardar_evaluacion"
          method="POST"
          class="flex-grow-1"
          style="font-size: 1.2rem"
          onsubmit="return validarFormulario()"
        >
          <input type="hidden" name="match_id" value="{{ jugada.match_id }}" />
          <input type="hidden" name="jugador" value="{{ jugada.jugador }}" />
          <input type="hidden" name="modelo" value="{{ jugada.modelo }}" />
          <input
            type="hidden"
            name="movimiento"
            value="{{ jugada.movimiento | tojson | safe }}"
          />

          <h4 class="mb-3">Evaluaci√≥n por R√∫brica</h4>

          {% set dimensiones = [ ('Comprensi√≥n de Reglas', '¬øEl movimiento
          respeta las reglas b√°sicas del juego?'), ('Validez y Legalidad', '¬øEs
          un movimiento permitido y legal?'), ('Razonamiento Estrat√©gico', '¬øSe
          nota una intenci√≥n estrat√©gica en el movimiento?'), ('Factualidad',
          '¬øLa justificaci√≥n se basa en el estado real del tablero?'),
          ('Coherencia Explicativa', '¬øLa explicaci√≥n tiene sentido con el
          movimiento realizado?'), ('Claridad Ling√º√≠stica', '¬øEst√° bien
          expresado, sin errores graves?'), ('Adaptabilidad', '¬øSe adapta al
          contexto actual del juego?') ] %} {% for nombre, descripcion in
          dimensiones %}
          <div class="mb-4">
            <label class="form-label fw-bold">{{ nombre }}</label>
            <p class="text-muted">{{ descripcion }}</p>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="rubrica[{{ nombre }}]"
                value="1"
                required
              />
              <label class="form-check-label">1 - Bajo</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="rubrica[{{ nombre }}]"
                value="2"
              />
              <label class="form-check-label">2 - Medio</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="rubrica[{{ nombre }}]"
                value="3"
              />
              <label class="form-check-label">3 - Alto</label>
            </div>
          </div>
          {% endfor %}

          <div class="mb-3">
            <label for="razon" class="form-label fw-bold"
              >Explicaci√≥n general de la evaluaci√≥n</label
            >
            <textarea
              name="razon"
              id="razon"
              class="form-control"
              rows="4"
              style="font-size: 1.1rem"
              placeholder="Escribe una justificaci√≥n completa..."
            ></textarea>
          </div>

          <button type="submit" class="btn btn-success btn-lg w-100">
            ‚úÖ Guardar Evaluaci√≥n
          </button>
        </form>

        <!-- Siguiente jugada (sin guardar) -->
        <!-- <form
          action="/siguiente_jugada"
          method="POST"
          class="flex-grow-1 d-flex align-items-end"
        >
          <input type="hidden" name="match_id" value="{{ jugada.match_id }}">
          <input type="hidden" name="movimiento" value="{{ jugada.movimiento | tojson | safe }}">
          <button type="submit" class="btn btn-secondary btn-lg w-100">‚ñ∂ Siguiente</button>
        </form> -->
      </div>
      <!-- /d-flex -->

      <!-- Historial -->
      <a href="/evaluaciones_historial" class="btn-history mt-4" style="font-size: 1.2rem;"
        >üìú Ver historial de evaluaciones</a
      >

      {% else %}
      <p class="text-center fs-5 mt-5">
        No hay jugadas para evaluar a√∫n. Juega primero para generar jugadas.
      </p>
      {% endif %}
    </div>
    <!-- /container -->

    <!-- Contenedor de la jugada -->
    <!-- <div
      id="info-jugada"
      class="text-center mb-4 mt-4"
      style="font-size: 1.2rem"
    >
      <p><em>Cargando informaci√≥n de la jugada...</em></p>
    </div> -->

    <!-- Contenedor del tablero -->
    <div id="tablero-dinamico" class="mt-3 mb-3"></div>

    <script>
      function toggleRubrica() {
        const panel = document.getElementById("rubricaPanel");
        panel.classList.toggle("open");
      }

      function validarFormulario() {
        const form = document.querySelector(
          'form[action="/guardar_evaluacion"]'
        );
        if (!form) return true;

        const dimensiones = [
          "Comprensi√≥n de Reglas",
          "Validez y Legalidad",
          "Razonamiento Estrat√©gico",
          "Factualidad",
          "Coherencia Explicativa",
          "Claridad Ling√º√≠stica",
          "Adaptabilidad",
        ];

        for (const dim of dimensiones) {
          const radios = document.getElementsByName(`rubrica[${dim}]`);
          if (![...radios].some((radio) => radio.checked)) {
            alert(`Por favor, eval√∫a la dimensi√≥n: "${dim}"`);
            return false;
          }
        }

        const razonEl = document.getElementById("razon");
        if (razonEl && razonEl.value.trim().length < 3) {
          alert("Por favor, escribe una explicaci√≥n m√°s completa.");
          return false;
        }

        return true;
      }

      function renderTablero(tablero) {
        const contenedor = document.getElementById("tablero-dinamico");
        contenedor.innerHTML = "";
        const table = document.createElement("table");
        table.className = "tablero";
        for (let i = 0; i < 3; i++) {
          const row = document.createElement("tr");
          for (let j = 0; j < 3; j++) {
            const cell = document.createElement("td");
            const value = tablero[i][j];
            if (value !== "b") {
              cell.innerText = value.toUpperCase();
              cell.classList.add(value);
            }
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
        contenedor.appendChild(table);
      }

      function cargarInfoJugada() {
        fetch("/info_jugada_sesion")
          .then((res) => res.json())
          .then((data) => {
            const contenedor = document.getElementById("info-jugada");

            if (data.error) {
              contenedor.innerHTML = "<p>No hay jugadas a√∫n.</p>";
            } else {
              contenedor.innerHTML = `
          <p><strong>Jugador:</strong> ${data.jugador}</p>
          <p><strong>Modelo:</strong> ${data.modelo}</p>
          <p><strong>Movimiento:</strong> ${data.movimiento}</p>
        `;
            }
          })
          .catch((err) => {
            console.error("Error al cargar info de la jugada:", err);
            document.getElementById("info-jugada").innerHTML =
              "<p>Error al cargar info de la jugada.</p>";
          });
      }

      fetch("/estado")
        .then((res) => res.json())
        .then((data) => {
          renderTablero(data.tablero);
          cargarInfoJugada();
        });
    </script>

    <!-- Bootstrap bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
