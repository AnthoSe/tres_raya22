<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Historial de Evaluaciones - Tres en Raya IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Carga CSS externo -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/historial.css') }}">
</head>

<body>
  <button class="btn-back" onclick="window.location.href='/evaluar'">← Regresar</button>

  <div class="container">
    <h1>Historial de Evaluaciones</h1>
    <button class="btn btn-outline-secondary rubrica-toggle-btn" onclick="toggleRubrica()">Ver Rúbrica</button>
    <a href="/evaluar" class="btn btn-primary mb-3">Volver a evaluar</a>

    <input type="text" id="filtro" class="form-control mb-3" placeholder="Buscar por modelo o jugador..." />

    <div class="table-responsive">
      <table class="table table-bordered align-middle table-striped" role="table" aria-label="Historial de evaluaciones">
        <thead class="table-dark text-center">
          <tr>
            <th>Fecha</th>
            <th>Jugador</th>
            <th>Modelo</th>
            <th>Movimiento</th>
            <th>Evaluación</th>
            <th>Razón y Tablero</th>
          </tr>
        </thead>
        <tbody>
          {% for ev in evaluaciones %}
          <tr>
            <td>{{ ev.timestamp }}</td>
            <td>{{ ev.jugador | upper }}</td>
            <td>{{ ev.modelo }}</td>
            <td>{{ ev.movimiento_legible }}</td>
            <td class="text-center">
              <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="badge badge-eval
                  {% if ev.evaluacion == 'Buena' %}badge-Buena
                  {% elif ev.evaluacion == 'Mala' %}badge-Mala
                  {% elif ev.evaluacion == 'Creativa' %}badge-Creativa
                  {% else %}badge-Pudo{% endif %}" title="{% if ev.evaluacion == 'Buena' %}Buena: movimiento estratégico y correcto
                         {% elif ev.evaluacion == 'Mala' %}Mala: movimiento erróneo o sin sentido
                         {% elif ev.evaluacion == 'Creativa' %}Creativa: movimiento original o inesperado
                         {% else %}Puede mejorar: movimiento válido pero con errores
                         {% endif %}">
                  {{ ev.evaluacion }}
                </span>
              </div>
            </td>
            <td>
              <div class="razon-tablero">
                <pre>{{ ev.razon_texto or "Sin explicación" }}</pre>
                {% if ev.tablero is string %}
                <pre>{{ ev.tablero }}</pre>
                {% else %}
                <div class="tablero-mini">
                  {% for fila in ev.tablero %}
                  <div>
                    {% for celda in fila %}
                    <span>{{ celda if celda != 'b' else '-' }}</span>
                    {% endfor %}
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center fst-italic">No hay evaluaciones aún.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Panel lateral de rúbrica -->
  <div id="rubricaPanel" aria-hidden="true" role="region" aria-label="Rúbrica de evaluación">
    <h3>Rúbrica de Evaluación</h3>
    <div id="rubricaContent">
      {% for r in [
      ("Comprensión de Reglas", "Viola reglas básicas: casilla ocupada o fuera del tablero.", "Cumple reglas básicas,
      pero omite situaciones menos evidentes.", "Siempre movimientos legales, respeta todas las reglas del turno."),

      ("Validez y Legalidad", "Movimiento inválido o ilegal.", "Movimiento válido sin análisis profundo.", "Válido y
      elegido tras un análisis completo."),

      ("Razonamiento Estratégico", "Acción sin lógica.", "Intención simple (bloquear/avanzar), sin anticipación.",
      "Justificación clara, anticipa jugadas."),

      ("Factualidad", "Incorrecta o no relacionada con tablero.", "Generalmente correcta con imprecisiones.", "Precisa y
      basada en hechos concretos."),

      ("Coherencia Explicativa", "Confusa o contradictoria.", "Clara pero superficial.", "Lógica, completa y coherente."),

      ("Claridad Lingüística", "Lenguaje poco claro.", "Claro con errores menores.", "Preciso, correcto y comprensible."),

      ("Adaptabilidad", "Ignora cambios previos.", "Se adapta de forma básica o tardía.", "Rápida adaptación y ajuste efectivo.")
      ] %}
      <div class="rubrica-entry">
        <h5>{{ r[0] }}</h5>
        <p><strong>1:</strong> {{ r[1] }}</p>
        <p><strong>2:</strong> {{ r[2] }}</p>
        <p><strong>3:</strong> {{ r[3] }}</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/historial.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
