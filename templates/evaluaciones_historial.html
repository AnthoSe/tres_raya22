<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Evaluaciones - Tres en Raya IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/css/historial.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <button class="btn-back" onclick="window.location.href='/evaluar'">‚Üê Regresar</button>

  <div class="container">
    <h1>Historial de Evaluaciones</h1>

    <button class="btn btn-outline-secondary rubrica-toggle-btn" onclick="toggleRubrica()">Ver R√∫brica</button>
    <a href="/evaluar" class="btn btn-primary mb-3">Volver a evaluar</a>

    <input type="text" id="filtro" class="form-control mb-3" placeholder="Buscar por modelo o jugador..." />

    <div class="table-responsive">
      <table class="table table-bordered align-middle table-striped" role="table" aria-label="Historial de evaluaciones">
        <thead class="table-dark text-center">
          <tr>
            <th>Fecha</th>
            <th>Jugador</th>
            <th>Modelo</th>
            <th>Movimiento</th>
            <th>Evaluaci√≥n</th>
            <th>Raz√≥n y Tablero</th>
          </tr>
        </thead>
        <tbody>
          {% for ev in evaluaciones %}
          <tr>
            <td>{{ ev.timestamp }}</td>
            <td>{{ ev.jugador | upper }}</td>
            <td>{{ ev.modelo }}</td>
            <td>{{ ev.movimiento_legible }}</td>
            <td class="text-center">
              <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="badge badge-eval
                    {% if ev.evaluacion == 'Buena' %}badge-Buena
                    {% elif ev.evaluacion == 'Mala' %}badge-Mala
                    {% elif ev.evaluacion == 'Creativa' %}badge-Creativa
                    {% else %}badge-Pudo{% endif %}" title="{% if ev.evaluacion == 'Buena' %}Buena: movimiento estrat√©gico y correcto
                          {% elif ev.evaluacion == 'Mala' %}Mala: movimiento err√≥neo o sin sentido
                          {% elif ev.evaluacion == 'Creativa' %}Creativa: movimiento original o inesperado
                          {% else %}Puede mejorar: movimiento v√°lido pero con errores
                          {% endif %}">
                  {{ ev.evaluacion }}
                </span>
              </div>
            </td>
            <td>
              <div class="razon-tablero">
                <pre>{{ ev.razon_texto or "Sin explicaci√≥n" }}</pre>
                {% if ev.tablero is string %}
                <pre>{{ ev.tablero }}</pre>
                {% else %}
                <div class="tablero-mini">
                  {% for fila in ev.tablero %}
                  <div>
                    {% for celda in fila %}
                    <span>{{ celda if celda != 'b' else '-' }}</span>
                    {% endfor %}
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center fst-italic">No hay evaluaciones a√∫n.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- üîΩ Radar abajo del historial -->
    <div id="radarContainer" aria-label="Gr√°fico radar resumen de evaluaciones">
      <h2>Resumen Promedio por Dimensi√≥n</h2>
      <canvas id="graficoRadar" aria-label="Gr√°fico radar evaluaciones" role="img"></canvas>
    </div>
  </div>

  <!-- Panel lateral de r√∫brica -->
  <div id="rubricaPanel" aria-hidden="true" role="region" aria-label="R√∫brica de evaluaci√≥n">
    <h3>R√∫brica de Evaluaci√≥n</h3>
    <div id="rubricaContent">
      {% for r in [
      ("Comprensi√≥n de Reglas", "Viola reglas b√°sicas: casilla ocupada o fuera del tablero.", "Cumple reglas b√°sicas, pero omite situaciones menos evidentes.", "Siempre movimientos legales, respeta todas las reglas del turno."),
      ("Validez y Legalidad", "Movimiento inv√°lido o ilegal.", "Movimiento v√°lido sin an√°lisis profundo.", "V√°lido y elegido tras un an√°lisis completo."),
      ("Razonamiento Estrat√©gico", "Acci√≥n sin l√≥gica.", "Intenci√≥n simple (bloquear/avanzar), sin anticipaci√≥n.", "Justificaci√≥n clara, anticipa jugadas."),
      ("Factualidad", "Incorrecta o no relacionada con tablero.", "Generalmente correcta con imprecisiones.", "Precisa y basada en hechos concretos."),
      ("Coherencia Explicativa", "Confusa o contradictoria.", "Clara pero superficial.", "L√≥gica, completa y coherente."),
      ("Claridad Ling√º√≠stica", "Lenguaje poco claro.", "Claro con errores menores.", "Preciso, correcto y comprensible."),
      ("Adaptabilidad", "Ignora cambios previos.", "Se adapta de forma b√°sica o tard√≠a.", "R√°pida adaptaci√≥n y ajuste efectivo.")
      ] %}
      <div class="rubrica-entry">
        <h5>{{ r[0] }}</h5>
        <p><strong>1:</strong> {{ r[1] }}</p>
        <p><strong>2:</strong> {{ r[2] }}</p>
        <p><strong>3:</strong> {{ r[3] }}</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Variables desde Flask -->
  <script>
    window.dimensiones = {{ dimensiones | tojson }};
    window.promedios = {{ promedios | tojson }};
  </script>

  <!-- Scripts -->
  <script src="/static/js/historial.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
